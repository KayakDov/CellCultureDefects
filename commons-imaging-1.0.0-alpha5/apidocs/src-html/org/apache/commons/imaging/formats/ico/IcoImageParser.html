<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (17) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.apache.commons.imaging.formats.ico, class: IcoImageParser">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*</span>
<span class="source-line-no">002</span><span id="line-2"> * Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="source-line-no">003</span><span id="line-3"> * contributor license agreements.  See the NOTICE file distributed with</span>
<span class="source-line-no">004</span><span id="line-4"> * this work for additional information regarding copyright ownership.</span>
<span class="source-line-no">005</span><span id="line-5"> * The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="source-line-no">006</span><span id="line-6"> * (the "License"); you may not use this file except in compliance with</span>
<span class="source-line-no">007</span><span id="line-7"> * the License.  You may obtain a copy of the License at</span>
<span class="source-line-no">008</span><span id="line-8"> *</span>
<span class="source-line-no">009</span><span id="line-9"> *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="source-line-no">010</span><span id="line-10"> *</span>
<span class="source-line-no">011</span><span id="line-11"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="source-line-no">012</span><span id="line-12"> * distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="source-line-no">013</span><span id="line-13"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="source-line-no">014</span><span id="line-14"> * See the License for the specific language governing permissions and</span>
<span class="source-line-no">015</span><span id="line-15"> * limitations under the License.</span>
<span class="source-line-no">016</span><span id="line-16"> */</span>
<span class="source-line-no">017</span><span id="line-17">package org.apache.commons.imaging.formats.ico;</span>
<span class="source-line-no">018</span><span id="line-18"></span>
<span class="source-line-no">019</span><span id="line-19">import static org.apache.commons.imaging.common.BinaryFunctions.read2Bytes;</span>
<span class="source-line-no">020</span><span id="line-20">import static org.apache.commons.imaging.common.BinaryFunctions.read4Bytes;</span>
<span class="source-line-no">021</span><span id="line-21">import static org.apache.commons.imaging.common.BinaryFunctions.readByte;</span>
<span class="source-line-no">022</span><span id="line-22">import static org.apache.commons.imaging.common.BinaryFunctions.readBytes;</span>
<span class="source-line-no">023</span><span id="line-23"></span>
<span class="source-line-no">024</span><span id="line-24">import java.awt.Dimension;</span>
<span class="source-line-no">025</span><span id="line-25">import java.awt.image.BufferedImage;</span>
<span class="source-line-no">026</span><span id="line-26">import java.io.ByteArrayInputStream;</span>
<span class="source-line-no">027</span><span id="line-27">import java.io.ByteArrayOutputStream;</span>
<span class="source-line-no">028</span><span id="line-28">import java.io.IOException;</span>
<span class="source-line-no">029</span><span id="line-29">import java.io.InputStream;</span>
<span class="source-line-no">030</span><span id="line-30">import java.io.OutputStream;</span>
<span class="source-line-no">031</span><span id="line-31">import java.io.PrintWriter;</span>
<span class="source-line-no">032</span><span id="line-32">import java.nio.ByteOrder;</span>
<span class="source-line-no">033</span><span id="line-33">import java.util.List;</span>
<span class="source-line-no">034</span><span id="line-34"></span>
<span class="source-line-no">035</span><span id="line-35">import org.apache.commons.imaging.AbstractImageParser;</span>
<span class="source-line-no">036</span><span id="line-36">import org.apache.commons.imaging.ImageFormat;</span>
<span class="source-line-no">037</span><span id="line-37">import org.apache.commons.imaging.ImageFormats;</span>
<span class="source-line-no">038</span><span id="line-38">import org.apache.commons.imaging.ImageInfo;</span>
<span class="source-line-no">039</span><span id="line-39">import org.apache.commons.imaging.Imaging;</span>
<span class="source-line-no">040</span><span id="line-40">import org.apache.commons.imaging.ImagingException;</span>
<span class="source-line-no">041</span><span id="line-41">import org.apache.commons.imaging.PixelDensity;</span>
<span class="source-line-no">042</span><span id="line-42">import org.apache.commons.imaging.bytesource.ByteSource;</span>
<span class="source-line-no">043</span><span id="line-43">import org.apache.commons.imaging.common.Allocator;</span>
<span class="source-line-no">044</span><span id="line-44">import org.apache.commons.imaging.common.BinaryOutputStream;</span>
<span class="source-line-no">045</span><span id="line-45">import org.apache.commons.imaging.common.ImageMetadata;</span>
<span class="source-line-no">046</span><span id="line-46">import org.apache.commons.imaging.formats.bmp.BmpImageParser;</span>
<span class="source-line-no">047</span><span id="line-47">import org.apache.commons.imaging.palette.PaletteFactory;</span>
<span class="source-line-no">048</span><span id="line-48">import org.apache.commons.imaging.palette.SimplePalette;</span>
<span class="source-line-no">049</span><span id="line-49"></span>
<span class="source-line-no">050</span><span id="line-50">public class IcoImageParser extends AbstractImageParser&lt;IcoImagingParameters&gt; {</span>
<span class="source-line-no">051</span><span id="line-51">    private static final class BitmapHeader {</span>
<span class="source-line-no">052</span><span id="line-52">        public final int size;</span>
<span class="source-line-no">053</span><span id="line-53">        public final int width;</span>
<span class="source-line-no">054</span><span id="line-54">        public final int height;</span>
<span class="source-line-no">055</span><span id="line-55">        public final int planes;</span>
<span class="source-line-no">056</span><span id="line-56">        public final int bitCount;</span>
<span class="source-line-no">057</span><span id="line-57">        public final int compression;</span>
<span class="source-line-no">058</span><span id="line-58">        public final int sizeImage;</span>
<span class="source-line-no">059</span><span id="line-59">        public final int xPelsPerMeter;</span>
<span class="source-line-no">060</span><span id="line-60">        public final int yPelsPerMeter;</span>
<span class="source-line-no">061</span><span id="line-61">        public final int colorsUsed;</span>
<span class="source-line-no">062</span><span id="line-62">        public final int colorsImportant;</span>
<span class="source-line-no">063</span><span id="line-63"></span>
<span class="source-line-no">064</span><span id="line-64">        BitmapHeader(final int size, final int width, final int height, final int planes, final int bitCount, final int compression, final int sizeImage,</span>
<span class="source-line-no">065</span><span id="line-65">                final int pelsPerMeter, final int pelsPerMeter2, final int colorsUsed, final int colorsImportant) {</span>
<span class="source-line-no">066</span><span id="line-66">            this.size = size;</span>
<span class="source-line-no">067</span><span id="line-67">            this.width = width;</span>
<span class="source-line-no">068</span><span id="line-68">            this.height = height;</span>
<span class="source-line-no">069</span><span id="line-69">            this.planes = planes;</span>
<span class="source-line-no">070</span><span id="line-70">            this.bitCount = bitCount;</span>
<span class="source-line-no">071</span><span id="line-71">            this.compression = compression;</span>
<span class="source-line-no">072</span><span id="line-72">            this.sizeImage = sizeImage;</span>
<span class="source-line-no">073</span><span id="line-73">            xPelsPerMeter = pelsPerMeter;</span>
<span class="source-line-no">074</span><span id="line-74">            yPelsPerMeter = pelsPerMeter2;</span>
<span class="source-line-no">075</span><span id="line-75">            this.colorsUsed = colorsUsed;</span>
<span class="source-line-no">076</span><span id="line-76">            this.colorsImportant = colorsImportant;</span>
<span class="source-line-no">077</span><span id="line-77">        }</span>
<span class="source-line-no">078</span><span id="line-78"></span>
<span class="source-line-no">079</span><span id="line-79">        public void dump(final PrintWriter pw) {</span>
<span class="source-line-no">080</span><span id="line-80">            pw.println("BitmapHeader");</span>
<span class="source-line-no">081</span><span id="line-81"></span>
<span class="source-line-no">082</span><span id="line-82">            pw.println("Size: " + size);</span>
<span class="source-line-no">083</span><span id="line-83">            pw.println("Width: " + width);</span>
<span class="source-line-no">084</span><span id="line-84">            pw.println("Height: " + height);</span>
<span class="source-line-no">085</span><span id="line-85">            pw.println("Planes: " + planes);</span>
<span class="source-line-no">086</span><span id="line-86">            pw.println("BitCount: " + bitCount);</span>
<span class="source-line-no">087</span><span id="line-87">            pw.println("Compression: " + compression);</span>
<span class="source-line-no">088</span><span id="line-88">            pw.println("SizeImage: " + sizeImage);</span>
<span class="source-line-no">089</span><span id="line-89">            pw.println("XPelsPerMeter: " + xPelsPerMeter);</span>
<span class="source-line-no">090</span><span id="line-90">            pw.println("YPelsPerMeter: " + yPelsPerMeter);</span>
<span class="source-line-no">091</span><span id="line-91">            pw.println("ColorsUsed: " + colorsUsed);</span>
<span class="source-line-no">092</span><span id="line-92">            pw.println("ColorsImportant: " + colorsImportant);</span>
<span class="source-line-no">093</span><span id="line-93">        }</span>
<span class="source-line-no">094</span><span id="line-94">    }</span>
<span class="source-line-no">095</span><span id="line-95"></span>
<span class="source-line-no">096</span><span id="line-96">    private static final class BitmapIconData extends IconData {</span>
<span class="source-line-no">097</span><span id="line-97">        public final BitmapHeader header;</span>
<span class="source-line-no">098</span><span id="line-98">        public final BufferedImage bufferedImage;</span>
<span class="source-line-no">099</span><span id="line-99"></span>
<span class="source-line-no">100</span><span id="line-100">        BitmapIconData(final IconInfo iconInfo, final BitmapHeader header, final BufferedImage bufferedImage) {</span>
<span class="source-line-no">101</span><span id="line-101">            super(iconInfo);</span>
<span class="source-line-no">102</span><span id="line-102">            this.header = header;</span>
<span class="source-line-no">103</span><span id="line-103">            this.bufferedImage = bufferedImage;</span>
<span class="source-line-no">104</span><span id="line-104">        }</span>
<span class="source-line-no">105</span><span id="line-105"></span>
<span class="source-line-no">106</span><span id="line-106">        @Override</span>
<span class="source-line-no">107</span><span id="line-107">        protected void dumpSubclass(final PrintWriter pw) {</span>
<span class="source-line-no">108</span><span id="line-108">            pw.println("BitmapIconData");</span>
<span class="source-line-no">109</span><span id="line-109">            header.dump(pw);</span>
<span class="source-line-no">110</span><span id="line-110">            pw.println();</span>
<span class="source-line-no">111</span><span id="line-111">        }</span>
<span class="source-line-no">112</span><span id="line-112"></span>
<span class="source-line-no">113</span><span id="line-113">        @Override</span>
<span class="source-line-no">114</span><span id="line-114">        public BufferedImage readBufferedImage() throws ImagingException {</span>
<span class="source-line-no">115</span><span id="line-115">            return bufferedImage;</span>
<span class="source-line-no">116</span><span id="line-116">        }</span>
<span class="source-line-no">117</span><span id="line-117">    }</span>
<span class="source-line-no">118</span><span id="line-118"></span>
<span class="source-line-no">119</span><span id="line-119">    private static final class FileHeader {</span>
<span class="source-line-no">120</span><span id="line-120">        public final int reserved; // Reserved (2 bytes), always 0</span>
<span class="source-line-no">121</span><span id="line-121">        public final int iconType; // IconType (2 bytes), if the image is an</span>
<span class="source-line-no">122</span><span id="line-122">                                   // icon it?s 1, for cursors the value is 2.</span>
<span class="source-line-no">123</span><span id="line-123">        public final int iconCount; // IconCount (2 bytes), number of icons in</span>
<span class="source-line-no">124</span><span id="line-124">                                    // this file.</span>
<span class="source-line-no">125</span><span id="line-125"></span>
<span class="source-line-no">126</span><span id="line-126">        FileHeader(final int reserved, final int iconType, final int iconCount) {</span>
<span class="source-line-no">127</span><span id="line-127">            this.reserved = reserved;</span>
<span class="source-line-no">128</span><span id="line-128">            this.iconType = iconType;</span>
<span class="source-line-no">129</span><span id="line-129">            this.iconCount = iconCount;</span>
<span class="source-line-no">130</span><span id="line-130">        }</span>
<span class="source-line-no">131</span><span id="line-131"></span>
<span class="source-line-no">132</span><span id="line-132">        public void dump(final PrintWriter pw) {</span>
<span class="source-line-no">133</span><span id="line-133">            pw.println("FileHeader");</span>
<span class="source-line-no">134</span><span id="line-134">            pw.println("Reserved: " + reserved);</span>
<span class="source-line-no">135</span><span id="line-135">            pw.println("IconType: " + iconType);</span>
<span class="source-line-no">136</span><span id="line-136">            pw.println("IconCount: " + iconCount);</span>
<span class="source-line-no">137</span><span id="line-137">            pw.println();</span>
<span class="source-line-no">138</span><span id="line-138">        }</span>
<span class="source-line-no">139</span><span id="line-139">    }</span>
<span class="source-line-no">140</span><span id="line-140"></span>
<span class="source-line-no">141</span><span id="line-141">    abstract static class IconData {</span>
<span class="source-line-no">142</span><span id="line-142">        static final int SHALLOW_SIZE = 16;</span>
<span class="source-line-no">143</span><span id="line-143"></span>
<span class="source-line-no">144</span><span id="line-144">        public final IconInfo iconInfo;</span>
<span class="source-line-no">145</span><span id="line-145"></span>
<span class="source-line-no">146</span><span id="line-146">        IconData(final IconInfo iconInfo) {</span>
<span class="source-line-no">147</span><span id="line-147">            this.iconInfo = iconInfo;</span>
<span class="source-line-no">148</span><span id="line-148">        }</span>
<span class="source-line-no">149</span><span id="line-149"></span>
<span class="source-line-no">150</span><span id="line-150">        public void dump(final PrintWriter pw) {</span>
<span class="source-line-no">151</span><span id="line-151">            iconInfo.dump(pw);</span>
<span class="source-line-no">152</span><span id="line-152">            pw.println();</span>
<span class="source-line-no">153</span><span id="line-153">            dumpSubclass(pw);</span>
<span class="source-line-no">154</span><span id="line-154">        }</span>
<span class="source-line-no">155</span><span id="line-155"></span>
<span class="source-line-no">156</span><span id="line-156">        protected abstract void dumpSubclass(PrintWriter pw);</span>
<span class="source-line-no">157</span><span id="line-157"></span>
<span class="source-line-no">158</span><span id="line-158">        public abstract BufferedImage readBufferedImage() throws ImagingException;</span>
<span class="source-line-no">159</span><span id="line-159">    }</span>
<span class="source-line-no">160</span><span id="line-160"></span>
<span class="source-line-no">161</span><span id="line-161">    static class IconInfo {</span>
<span class="source-line-no">162</span><span id="line-162">        static final int SHALLOW_SIZE = 32;</span>
<span class="source-line-no">163</span><span id="line-163">        public final byte width;</span>
<span class="source-line-no">164</span><span id="line-164">        public final byte height;</span>
<span class="source-line-no">165</span><span id="line-165">        public final byte colorCount;</span>
<span class="source-line-no">166</span><span id="line-166">        public final byte reserved;</span>
<span class="source-line-no">167</span><span id="line-167">        public final int planes;</span>
<span class="source-line-no">168</span><span id="line-168">        public final int bitCount;</span>
<span class="source-line-no">169</span><span id="line-169">        public final int imageSize;</span>
<span class="source-line-no">170</span><span id="line-170">        public final int imageOffset;</span>
<span class="source-line-no">171</span><span id="line-171"></span>
<span class="source-line-no">172</span><span id="line-172">        IconInfo(final byte width, final byte height, final byte colorCount, final byte reserved, final int planes, final int bitCount, final int imageSize,</span>
<span class="source-line-no">173</span><span id="line-173">                final int imageOffset) {</span>
<span class="source-line-no">174</span><span id="line-174">            this.width = width;</span>
<span class="source-line-no">175</span><span id="line-175">            this.height = height;</span>
<span class="source-line-no">176</span><span id="line-176">            this.colorCount = colorCount;</span>
<span class="source-line-no">177</span><span id="line-177">            this.reserved = reserved;</span>
<span class="source-line-no">178</span><span id="line-178">            this.planes = planes;</span>
<span class="source-line-no">179</span><span id="line-179">            this.bitCount = bitCount;</span>
<span class="source-line-no">180</span><span id="line-180">            this.imageSize = imageSize;</span>
<span class="source-line-no">181</span><span id="line-181">            this.imageOffset = imageOffset;</span>
<span class="source-line-no">182</span><span id="line-182">        }</span>
<span class="source-line-no">183</span><span id="line-183"></span>
<span class="source-line-no">184</span><span id="line-184">        public void dump(final PrintWriter pw) {</span>
<span class="source-line-no">185</span><span id="line-185">            pw.println("IconInfo");</span>
<span class="source-line-no">186</span><span id="line-186">            pw.println("Width: " + width);</span>
<span class="source-line-no">187</span><span id="line-187">            pw.println("Height: " + height);</span>
<span class="source-line-no">188</span><span id="line-188">            pw.println("ColorCount: " + colorCount);</span>
<span class="source-line-no">189</span><span id="line-189">            pw.println("Reserved: " + reserved);</span>
<span class="source-line-no">190</span><span id="line-190">            pw.println("Planes: " + planes);</span>
<span class="source-line-no">191</span><span id="line-191">            pw.println("BitCount: " + bitCount);</span>
<span class="source-line-no">192</span><span id="line-192">            pw.println("ImageSize: " + imageSize);</span>
<span class="source-line-no">193</span><span id="line-193">            pw.println("ImageOffset: " + imageOffset);</span>
<span class="source-line-no">194</span><span id="line-194">        }</span>
<span class="source-line-no">195</span><span id="line-195">    }</span>
<span class="source-line-no">196</span><span id="line-196"></span>
<span class="source-line-no">197</span><span id="line-197">    private static final class ImageContents {</span>
<span class="source-line-no">198</span><span id="line-198">        public final FileHeader fileHeader;</span>
<span class="source-line-no">199</span><span id="line-199">        public final IconData[] iconDatas;</span>
<span class="source-line-no">200</span><span id="line-200"></span>
<span class="source-line-no">201</span><span id="line-201">        ImageContents(final FileHeader fileHeader, final IconData[] iconDatas) {</span>
<span class="source-line-no">202</span><span id="line-202">            this.fileHeader = fileHeader;</span>
<span class="source-line-no">203</span><span id="line-203">            this.iconDatas = iconDatas;</span>
<span class="source-line-no">204</span><span id="line-204">        }</span>
<span class="source-line-no">205</span><span id="line-205">    }</span>
<span class="source-line-no">206</span><span id="line-206"></span>
<span class="source-line-no">207</span><span id="line-207">    private static final class PngIconData extends IconData {</span>
<span class="source-line-no">208</span><span id="line-208">        public final BufferedImage bufferedImage;</span>
<span class="source-line-no">209</span><span id="line-209"></span>
<span class="source-line-no">210</span><span id="line-210">        PngIconData(final IconInfo iconInfo, final BufferedImage bufferedImage) {</span>
<span class="source-line-no">211</span><span id="line-211">            super(iconInfo);</span>
<span class="source-line-no">212</span><span id="line-212">            this.bufferedImage = bufferedImage;</span>
<span class="source-line-no">213</span><span id="line-213">        }</span>
<span class="source-line-no">214</span><span id="line-214"></span>
<span class="source-line-no">215</span><span id="line-215">        @Override</span>
<span class="source-line-no">216</span><span id="line-216">        protected void dumpSubclass(final PrintWriter pw) {</span>
<span class="source-line-no">217</span><span id="line-217">            pw.println("PNGIconData");</span>
<span class="source-line-no">218</span><span id="line-218">            pw.println();</span>
<span class="source-line-no">219</span><span id="line-219">        }</span>
<span class="source-line-no">220</span><span id="line-220"></span>
<span class="source-line-no">221</span><span id="line-221">        @Override</span>
<span class="source-line-no">222</span><span id="line-222">        public BufferedImage readBufferedImage() {</span>
<span class="source-line-no">223</span><span id="line-223">            return bufferedImage;</span>
<span class="source-line-no">224</span><span id="line-224">        }</span>
<span class="source-line-no">225</span><span id="line-225">    }</span>
<span class="source-line-no">226</span><span id="line-226"></span>
<span class="source-line-no">227</span><span id="line-227">    private static final String DEFAULT_EXTENSION = ImageFormats.ICO.getDefaultExtension();</span>
<span class="source-line-no">228</span><span id="line-228"></span>
<span class="source-line-no">229</span><span id="line-229">    private static final String[] ACCEPTED_EXTENSIONS = ImageFormats.ICO.getExtensions();</span>
<span class="source-line-no">230</span><span id="line-230"></span>
<span class="source-line-no">231</span><span id="line-231">    public IcoImageParser() {</span>
<span class="source-line-no">232</span><span id="line-232">        super(ByteOrder.LITTLE_ENDIAN);</span>
<span class="source-line-no">233</span><span id="line-233">    }</span>
<span class="source-line-no">234</span><span id="line-234"></span>
<span class="source-line-no">235</span><span id="line-235">    @Override</span>
<span class="source-line-no">236</span><span id="line-236">    public boolean dumpImageFile(final PrintWriter pw, final ByteSource byteSource) throws ImagingException, IOException {</span>
<span class="source-line-no">237</span><span id="line-237">        final ImageContents contents = readImage(byteSource);</span>
<span class="source-line-no">238</span><span id="line-238">        contents.fileHeader.dump(pw);</span>
<span class="source-line-no">239</span><span id="line-239">        for (final IconData iconData : contents.iconDatas) {</span>
<span class="source-line-no">240</span><span id="line-240">            iconData.dump(pw);</span>
<span class="source-line-no">241</span><span id="line-241">        }</span>
<span class="source-line-no">242</span><span id="line-242">        return true;</span>
<span class="source-line-no">243</span><span id="line-243">    }</span>
<span class="source-line-no">244</span><span id="line-244"></span>
<span class="source-line-no">245</span><span id="line-245">    @Override</span>
<span class="source-line-no">246</span><span id="line-246">    protected String[] getAcceptedExtensions() {</span>
<span class="source-line-no">247</span><span id="line-247">        return ACCEPTED_EXTENSIONS;</span>
<span class="source-line-no">248</span><span id="line-248">    }</span>
<span class="source-line-no">249</span><span id="line-249"></span>
<span class="source-line-no">250</span><span id="line-250">    @Override</span>
<span class="source-line-no">251</span><span id="line-251">    protected ImageFormat[] getAcceptedTypes() {</span>
<span class="source-line-no">252</span><span id="line-252">        return new ImageFormat[] { ImageFormats.ICO, //</span>
<span class="source-line-no">253</span><span id="line-253">        };</span>
<span class="source-line-no">254</span><span id="line-254">    }</span>
<span class="source-line-no">255</span><span id="line-255"></span>
<span class="source-line-no">256</span><span id="line-256">    @Override</span>
<span class="source-line-no">257</span><span id="line-257">    public List&lt;BufferedImage&gt; getAllBufferedImages(final ByteSource byteSource) throws ImagingException, IOException {</span>
<span class="source-line-no">258</span><span id="line-258">        final ImageContents contents = readImage(byteSource);</span>
<span class="source-line-no">259</span><span id="line-259"></span>
<span class="source-line-no">260</span><span id="line-260">        final FileHeader fileHeader = contents.fileHeader;</span>
<span class="source-line-no">261</span><span id="line-261">        final List&lt;BufferedImage&gt; result = Allocator.arrayList(fileHeader.iconCount);</span>
<span class="source-line-no">262</span><span id="line-262">        for (int i = 0; i &lt; fileHeader.iconCount; i++) {</span>
<span class="source-line-no">263</span><span id="line-263">            result.add(contents.iconDatas[i].readBufferedImage());</span>
<span class="source-line-no">264</span><span id="line-264">        }</span>
<span class="source-line-no">265</span><span id="line-265"></span>
<span class="source-line-no">266</span><span id="line-266">        return result;</span>
<span class="source-line-no">267</span><span id="line-267">    }</span>
<span class="source-line-no">268</span><span id="line-268"></span>
<span class="source-line-no">269</span><span id="line-269">    @Override</span>
<span class="source-line-no">270</span><span id="line-270">    public final BufferedImage getBufferedImage(final ByteSource byteSource, final IcoImagingParameters params) throws ImagingException, IOException {</span>
<span class="source-line-no">271</span><span id="line-271">        final ImageContents contents = readImage(byteSource);</span>
<span class="source-line-no">272</span><span id="line-272">        final FileHeader fileHeader = contents.fileHeader;</span>
<span class="source-line-no">273</span><span id="line-273">        if (fileHeader.iconCount &gt; 0) {</span>
<span class="source-line-no">274</span><span id="line-274">            return contents.iconDatas[0].readBufferedImage();</span>
<span class="source-line-no">275</span><span id="line-275">        }</span>
<span class="source-line-no">276</span><span id="line-276">        throw new ImagingException("No icons in ICO file");</span>
<span class="source-line-no">277</span><span id="line-277">    }</span>
<span class="source-line-no">278</span><span id="line-278"></span>
<span class="source-line-no">279</span><span id="line-279">    @Override</span>
<span class="source-line-no">280</span><span id="line-280">    public String getDefaultExtension() {</span>
<span class="source-line-no">281</span><span id="line-281">        return DEFAULT_EXTENSION;</span>
<span class="source-line-no">282</span><span id="line-282">    }</span>
<span class="source-line-no">283</span><span id="line-283"></span>
<span class="source-line-no">284</span><span id="line-284">    @Override</span>
<span class="source-line-no">285</span><span id="line-285">    public IcoImagingParameters getDefaultParameters() {</span>
<span class="source-line-no">286</span><span id="line-286">        return new IcoImagingParameters();</span>
<span class="source-line-no">287</span><span id="line-287">    }</span>
<span class="source-line-no">288</span><span id="line-288"></span>
<span class="source-line-no">289</span><span id="line-289">    // TODO should throw UOE</span>
<span class="source-line-no">290</span><span id="line-290">    @Override</span>
<span class="source-line-no">291</span><span id="line-291">    public byte[] getIccProfileBytes(final ByteSource byteSource, final IcoImagingParameters params) throws ImagingException, IOException {</span>
<span class="source-line-no">292</span><span id="line-292">        return null;</span>
<span class="source-line-no">293</span><span id="line-293">    }</span>
<span class="source-line-no">294</span><span id="line-294"></span>
<span class="source-line-no">295</span><span id="line-295">    // TODO should throw UOE</span>
<span class="source-line-no">296</span><span id="line-296">    @Override</span>
<span class="source-line-no">297</span><span id="line-297">    public ImageInfo getImageInfo(final ByteSource byteSource, final IcoImagingParameters params) throws ImagingException, IOException {</span>
<span class="source-line-no">298</span><span id="line-298">        return null;</span>
<span class="source-line-no">299</span><span id="line-299">    }</span>
<span class="source-line-no">300</span><span id="line-300"></span>
<span class="source-line-no">301</span><span id="line-301">    // TODO should throw UOE</span>
<span class="source-line-no">302</span><span id="line-302">    @Override</span>
<span class="source-line-no">303</span><span id="line-303">    public Dimension getImageSize(final ByteSource byteSource, final IcoImagingParameters params) throws ImagingException, IOException {</span>
<span class="source-line-no">304</span><span id="line-304">        return null;</span>
<span class="source-line-no">305</span><span id="line-305">    }</span>
<span class="source-line-no">306</span><span id="line-306"></span>
<span class="source-line-no">307</span><span id="line-307">    // TODO should throw UOE</span>
<span class="source-line-no">308</span><span id="line-308">    @Override</span>
<span class="source-line-no">309</span><span id="line-309">    public ImageMetadata getMetadata(final ByteSource byteSource, final IcoImagingParameters params) throws ImagingException, IOException {</span>
<span class="source-line-no">310</span><span id="line-310">        return null;</span>
<span class="source-line-no">311</span><span id="line-311">    }</span>
<span class="source-line-no">312</span><span id="line-312"></span>
<span class="source-line-no">313</span><span id="line-313">    @Override</span>
<span class="source-line-no">314</span><span id="line-314">    public String getName() {</span>
<span class="source-line-no">315</span><span id="line-315">        return "ico-Custom";</span>
<span class="source-line-no">316</span><span id="line-316">    }</span>
<span class="source-line-no">317</span><span id="line-317"></span>
<span class="source-line-no">318</span><span id="line-318">    private IconData readBitmapIconData(final byte[] iconData, final IconInfo fIconInfo) throws ImagingException, IOException {</span>
<span class="source-line-no">319</span><span id="line-319">        final ByteArrayInputStream is = new ByteArrayInputStream(iconData);</span>
<span class="source-line-no">320</span><span id="line-320">        final int size = read4Bytes("size", is, "Not a Valid ICO File", getByteOrder()); // Size (4</span>
<span class="source-line-no">321</span><span id="line-321">        // bytes),</span>
<span class="source-line-no">322</span><span id="line-322">        // size of</span>
<span class="source-line-no">323</span><span id="line-323">        // this</span>
<span class="source-line-no">324</span><span id="line-324">        // structure</span>
<span class="source-line-no">325</span><span id="line-325">        // (always</span>
<span class="source-line-no">326</span><span id="line-326">        // 40)</span>
<span class="source-line-no">327</span><span id="line-327">        final int width = read4Bytes("width", is, "Not a Valid ICO File", getByteOrder()); // Width (4</span>
<span class="source-line-no">328</span><span id="line-328">        // bytes),</span>
<span class="source-line-no">329</span><span id="line-329">        // width of</span>
<span class="source-line-no">330</span><span id="line-330">        // the</span>
<span class="source-line-no">331</span><span id="line-331">        // image</span>
<span class="source-line-no">332</span><span id="line-332">        // (same as</span>
<span class="source-line-no">333</span><span id="line-333">        // iconinfo.width)</span>
<span class="source-line-no">334</span><span id="line-334">        final int height = read4Bytes("height", is, "Not a Valid ICO File", getByteOrder()); // Height</span>
<span class="source-line-no">335</span><span id="line-335">        // (4</span>
<span class="source-line-no">336</span><span id="line-336">        // bytes),</span>
<span class="source-line-no">337</span><span id="line-337">        // scanlines</span>
<span class="source-line-no">338</span><span id="line-338">        // in the</span>
<span class="source-line-no">339</span><span id="line-339">        // color</span>
<span class="source-line-no">340</span><span id="line-340">        // map +</span>
<span class="source-line-no">341</span><span id="line-341">        // transparent</span>
<span class="source-line-no">342</span><span id="line-342">        // map</span>
<span class="source-line-no">343</span><span id="line-343">        // (iconinfo.height</span>
<span class="source-line-no">344</span><span id="line-344">        // * 2)</span>
<span class="source-line-no">345</span><span id="line-345">        final int planes = read2Bytes("planes", is, "Not a Valid ICO File", getByteOrder()); // Planes</span>
<span class="source-line-no">346</span><span id="line-346">        // (2</span>
<span class="source-line-no">347</span><span id="line-347">        // bytes),</span>
<span class="source-line-no">348</span><span id="line-348">        // always</span>
<span class="source-line-no">349</span><span id="line-349">        // 1</span>
<span class="source-line-no">350</span><span id="line-350">        final int bitCount = read2Bytes("bitCount", is, "Not a Valid ICO File", getByteOrder()); // BitCount</span>
<span class="source-line-no">351</span><span id="line-351">        // (2</span>
<span class="source-line-no">352</span><span id="line-352">        // bytes),</span>
<span class="source-line-no">353</span><span id="line-353">        // 1,4,8,16,24,32</span>
<span class="source-line-no">354</span><span id="line-354">        // (see</span>
<span class="source-line-no">355</span><span id="line-355">        // iconinfo</span>
<span class="source-line-no">356</span><span id="line-356">        // for</span>
<span class="source-line-no">357</span><span id="line-357">        // details)</span>
<span class="source-line-no">358</span><span id="line-358">        int compression = read4Bytes("compression", is, "Not a Valid ICO File", getByteOrder()); // Compression</span>
<span class="source-line-no">359</span><span id="line-359">        // (4</span>
<span class="source-line-no">360</span><span id="line-360">        // bytes),</span>
<span class="source-line-no">361</span><span id="line-361">        // we</span>
<span class="source-line-no">362</span><span id="line-362">        // don?t</span>
<span class="source-line-no">363</span><span id="line-363">        // use</span>
<span class="source-line-no">364</span><span id="line-364">        // this</span>
<span class="source-line-no">365</span><span id="line-365">        // (0)</span>
<span class="source-line-no">366</span><span id="line-366">        final int sizeImage = read4Bytes("sizeImage", is, "Not a Valid ICO File", getByteOrder()); // SizeImage</span>
<span class="source-line-no">367</span><span id="line-367">        // (4</span>
<span class="source-line-no">368</span><span id="line-368">        // bytes),</span>
<span class="source-line-no">369</span><span id="line-369">        // we</span>
<span class="source-line-no">370</span><span id="line-370">        // don?t</span>
<span class="source-line-no">371</span><span id="line-371">        // use</span>
<span class="source-line-no">372</span><span id="line-372">        // this</span>
<span class="source-line-no">373</span><span id="line-373">        // (0)</span>
<span class="source-line-no">374</span><span id="line-374">        final int xPelsPerMeter = read4Bytes("xPelsPerMeter", is, "Not a Valid ICO File", getByteOrder()); // XPelsPerMeter (4 bytes), we don?t</span>
<span class="source-line-no">375</span><span id="line-375">        // use this (0)</span>
<span class="source-line-no">376</span><span id="line-376">        final int yPelsPerMeter = read4Bytes("yPelsPerMeter", is, "Not a Valid ICO File", getByteOrder()); // YPelsPerMeter (4 bytes), we don?t</span>
<span class="source-line-no">377</span><span id="line-377">        // use this (0)</span>
<span class="source-line-no">378</span><span id="line-378">        final int colorsUsed = read4Bytes("colorsUsed", is, "Not a Valid ICO File", getByteOrder()); // ColorsUsed</span>
<span class="source-line-no">379</span><span id="line-379">        // (4</span>
<span class="source-line-no">380</span><span id="line-380">        // bytes),</span>
<span class="source-line-no">381</span><span id="line-381">        // we</span>
<span class="source-line-no">382</span><span id="line-382">        // don?t</span>
<span class="source-line-no">383</span><span id="line-383">        // use</span>
<span class="source-line-no">384</span><span id="line-384">        // this</span>
<span class="source-line-no">385</span><span id="line-385">        // (0)</span>
<span class="source-line-no">386</span><span id="line-386">        final int colorsImportant = read4Bytes("ColorsImportant", is, "Not a Valid ICO File", getByteOrder()); // ColorsImportant (4 bytes), we don?t</span>
<span class="source-line-no">387</span><span id="line-387">        // use this (0)</span>
<span class="source-line-no">388</span><span id="line-388">        int redMask = 0;</span>
<span class="source-line-no">389</span><span id="line-389">        int greenMask = 0;</span>
<span class="source-line-no">390</span><span id="line-390">        int blueMask = 0;</span>
<span class="source-line-no">391</span><span id="line-391">        int alphaMask = 0;</span>
<span class="source-line-no">392</span><span id="line-392">        if (compression == 3) {</span>
<span class="source-line-no">393</span><span id="line-393">            redMask = read4Bytes("redMask", is, "Not a Valid ICO File", getByteOrder());</span>
<span class="source-line-no">394</span><span id="line-394">            greenMask = read4Bytes("greenMask", is, "Not a Valid ICO File", getByteOrder());</span>
<span class="source-line-no">395</span><span id="line-395">            blueMask = read4Bytes("blueMask", is, "Not a Valid ICO File", getByteOrder());</span>
<span class="source-line-no">396</span><span id="line-396">        }</span>
<span class="source-line-no">397</span><span id="line-397">        final byte[] restOfFile = readBytes("RestOfFile", is, is.available());</span>
<span class="source-line-no">398</span><span id="line-398"></span>
<span class="source-line-no">399</span><span id="line-399">        if (size != 40) {</span>
<span class="source-line-no">400</span><span id="line-400">            throw new ImagingException("Not a Valid ICO File: Wrong bitmap header size " + size);</span>
<span class="source-line-no">401</span><span id="line-401">        }</span>
<span class="source-line-no">402</span><span id="line-402">        if (planes != 1) {</span>
<span class="source-line-no">403</span><span id="line-403">            throw new ImagingException("Not a Valid ICO File: Planes can't be " + planes);</span>
<span class="source-line-no">404</span><span id="line-404">        }</span>
<span class="source-line-no">405</span><span id="line-405"></span>
<span class="source-line-no">406</span><span id="line-406">        if (compression == 0 &amp;&amp; bitCount == 32) {</span>
<span class="source-line-no">407</span><span id="line-407">            // 32 BPP RGB icons need an alpha channel, but BMP files don't have</span>
<span class="source-line-no">408</span><span id="line-408">            // one unless BI_BITFIELDS is used...</span>
<span class="source-line-no">409</span><span id="line-409">            compression = 3;</span>
<span class="source-line-no">410</span><span id="line-410">            redMask = 0x00ff0000;</span>
<span class="source-line-no">411</span><span id="line-411">            greenMask = 0x0000ff00;</span>
<span class="source-line-no">412</span><span id="line-412">            blueMask = 0x000000ff;</span>
<span class="source-line-no">413</span><span id="line-413">            alphaMask = 0xff000000;</span>
<span class="source-line-no">414</span><span id="line-414">        }</span>
<span class="source-line-no">415</span><span id="line-415"></span>
<span class="source-line-no">416</span><span id="line-416">        final BitmapHeader header = new BitmapHeader(size, width, height, planes, bitCount, compression, sizeImage, xPelsPerMeter, yPelsPerMeter, colorsUsed,</span>
<span class="source-line-no">417</span><span id="line-417">                colorsImportant);</span>
<span class="source-line-no">418</span><span id="line-418"></span>
<span class="source-line-no">419</span><span id="line-419">        final int bitmapPixelsOffset = 14 + 56 + 4 * (colorsUsed == 0 &amp;&amp; bitCount &lt;= 8 ? 1 &lt;&lt; bitCount : colorsUsed);</span>
<span class="source-line-no">420</span><span id="line-420">        final int bitmapSize = 14 + 56 + restOfFile.length;</span>
<span class="source-line-no">421</span><span id="line-421"></span>
<span class="source-line-no">422</span><span id="line-422">        final ByteArrayOutputStream baos = new ByteArrayOutputStream(Allocator.checkByteArray(bitmapSize));</span>
<span class="source-line-no">423</span><span id="line-423">        try (BinaryOutputStream bos = BinaryOutputStream.littleEndian(baos)) {</span>
<span class="source-line-no">424</span><span id="line-424">            bos.write('B');</span>
<span class="source-line-no">425</span><span id="line-425">            bos.write('M');</span>
<span class="source-line-no">426</span><span id="line-426">            bos.write4Bytes(bitmapSize);</span>
<span class="source-line-no">427</span><span id="line-427">            bos.write4Bytes(0);</span>
<span class="source-line-no">428</span><span id="line-428">            bos.write4Bytes(bitmapPixelsOffset);</span>
<span class="source-line-no">429</span><span id="line-429"></span>
<span class="source-line-no">430</span><span id="line-430">            bos.write4Bytes(56);</span>
<span class="source-line-no">431</span><span id="line-431">            bos.write4Bytes(width);</span>
<span class="source-line-no">432</span><span id="line-432">            bos.write4Bytes(height / 2);</span>
<span class="source-line-no">433</span><span id="line-433">            bos.write2Bytes(planes);</span>
<span class="source-line-no">434</span><span id="line-434">            bos.write2Bytes(bitCount);</span>
<span class="source-line-no">435</span><span id="line-435">            bos.write4Bytes(compression);</span>
<span class="source-line-no">436</span><span id="line-436">            bos.write4Bytes(sizeImage);</span>
<span class="source-line-no">437</span><span id="line-437">            bos.write4Bytes(xPelsPerMeter);</span>
<span class="source-line-no">438</span><span id="line-438">            bos.write4Bytes(yPelsPerMeter);</span>
<span class="source-line-no">439</span><span id="line-439">            bos.write4Bytes(colorsUsed);</span>
<span class="source-line-no">440</span><span id="line-440">            bos.write4Bytes(colorsImportant);</span>
<span class="source-line-no">441</span><span id="line-441">            bos.write4Bytes(redMask);</span>
<span class="source-line-no">442</span><span id="line-442">            bos.write4Bytes(greenMask);</span>
<span class="source-line-no">443</span><span id="line-443">            bos.write4Bytes(blueMask);</span>
<span class="source-line-no">444</span><span id="line-444">            bos.write4Bytes(alphaMask);</span>
<span class="source-line-no">445</span><span id="line-445">            bos.write(restOfFile);</span>
<span class="source-line-no">446</span><span id="line-446">            bos.flush();</span>
<span class="source-line-no">447</span><span id="line-447">        }</span>
<span class="source-line-no">448</span><span id="line-448"></span>
<span class="source-line-no">449</span><span id="line-449">        final ByteArrayInputStream bmpInputStream = new ByteArrayInputStream(baos.toByteArray());</span>
<span class="source-line-no">450</span><span id="line-450">        final BufferedImage bmpImage = new BmpImageParser().getBufferedImage(bmpInputStream, null);</span>
<span class="source-line-no">451</span><span id="line-451"></span>
<span class="source-line-no">452</span><span id="line-452">        // Transparency map is optional with 32 BPP icons, because they already</span>
<span class="source-line-no">453</span><span id="line-453">        // have</span>
<span class="source-line-no">454</span><span id="line-454">        // an alpha channel, and Windows only uses the transparency map when it</span>
<span class="source-line-no">455</span><span id="line-455">        // has to</span>
<span class="source-line-no">456</span><span id="line-456">        // display the icon on a &lt; 32 BPP screen. But it's still used instead of</span>
<span class="source-line-no">457</span><span id="line-457">        // alpha</span>
<span class="source-line-no">458</span><span id="line-458">        // if the image would be completely transparent with alpha...</span>
<span class="source-line-no">459</span><span id="line-459">        int tScanlineSize = (width + 7) / 8;</span>
<span class="source-line-no">460</span><span id="line-460">        if (tScanlineSize % 4 != 0) {</span>
<span class="source-line-no">461</span><span id="line-461">            tScanlineSize += 4 - tScanlineSize % 4; // pad scanline to 4</span>
<span class="source-line-no">462</span><span id="line-462">                                                    // byte size.</span>
<span class="source-line-no">463</span><span id="line-463">        }</span>
<span class="source-line-no">464</span><span id="line-464">        final int colorMapSizeBytes = tScanlineSize * (height / 2);</span>
<span class="source-line-no">465</span><span id="line-465">        byte[] transparencyMap = null;</span>
<span class="source-line-no">466</span><span id="line-466">        try {</span>
<span class="source-line-no">467</span><span id="line-467">            transparencyMap = readBytes("transparencyMap", bmpInputStream, colorMapSizeBytes, "Not a Valid ICO File");</span>
<span class="source-line-no">468</span><span id="line-468">        } catch (final IOException ioEx) {</span>
<span class="source-line-no">469</span><span id="line-469">            if (bitCount != 32) {</span>
<span class="source-line-no">470</span><span id="line-470">                throw ioEx;</span>
<span class="source-line-no">471</span><span id="line-471">            }</span>
<span class="source-line-no">472</span><span id="line-472">        }</span>
<span class="source-line-no">473</span><span id="line-473"></span>
<span class="source-line-no">474</span><span id="line-474">        boolean allAlphasZero = true;</span>
<span class="source-line-no">475</span><span id="line-475">        if (bitCount == 32) {</span>
<span class="source-line-no">476</span><span id="line-476">            for (int y = 0; allAlphasZero &amp;&amp; y &lt; bmpImage.getHeight(); y++) {</span>
<span class="source-line-no">477</span><span id="line-477">                for (int x = 0; x &lt; bmpImage.getWidth(); x++) {</span>
<span class="source-line-no">478</span><span id="line-478">                    if ((bmpImage.getRGB(x, y) &amp; 0xff000000) != 0) {</span>
<span class="source-line-no">479</span><span id="line-479">                        allAlphasZero = false;</span>
<span class="source-line-no">480</span><span id="line-480">                        break;</span>
<span class="source-line-no">481</span><span id="line-481">                    }</span>
<span class="source-line-no">482</span><span id="line-482">                }</span>
<span class="source-line-no">483</span><span id="line-483">            }</span>
<span class="source-line-no">484</span><span id="line-484">        }</span>
<span class="source-line-no">485</span><span id="line-485">        BufferedImage resultImage;</span>
<span class="source-line-no">486</span><span id="line-486">        if (allAlphasZero) {</span>
<span class="source-line-no">487</span><span id="line-487">            resultImage = new BufferedImage(bmpImage.getWidth(), bmpImage.getHeight(), BufferedImage.TYPE_INT_ARGB);</span>
<span class="source-line-no">488</span><span id="line-488">            for (int y = 0; y &lt; resultImage.getHeight(); y++) {</span>
<span class="source-line-no">489</span><span id="line-489">                for (int x = 0; x &lt; resultImage.getWidth(); x++) {</span>
<span class="source-line-no">490</span><span id="line-490">                    int alpha = 0xff;</span>
<span class="source-line-no">491</span><span id="line-491">                    if (transparencyMap != null) {</span>
<span class="source-line-no">492</span><span id="line-492">                        final int alphaByte = 0xff &amp; transparencyMap[tScanlineSize * (bmpImage.getHeight() - y - 1) + x / 8];</span>
<span class="source-line-no">493</span><span id="line-493">                        alpha = 0x01 &amp; alphaByte &gt;&gt; 7 - x % 8;</span>
<span class="source-line-no">494</span><span id="line-494">                        alpha = alpha == 0 ? 0xff : 0x00;</span>
<span class="source-line-no">495</span><span id="line-495">                    }</span>
<span class="source-line-no">496</span><span id="line-496">                    resultImage.setRGB(x, y, alpha &lt;&lt; 24 | 0xffffff &amp; bmpImage.getRGB(x, y));</span>
<span class="source-line-no">497</span><span id="line-497">                }</span>
<span class="source-line-no">498</span><span id="line-498">            }</span>
<span class="source-line-no">499</span><span id="line-499">        } else {</span>
<span class="source-line-no">500</span><span id="line-500">            resultImage = bmpImage;</span>
<span class="source-line-no">501</span><span id="line-501">        }</span>
<span class="source-line-no">502</span><span id="line-502">        return new BitmapIconData(fIconInfo, header, resultImage);</span>
<span class="source-line-no">503</span><span id="line-503">    }</span>
<span class="source-line-no">504</span><span id="line-504"></span>
<span class="source-line-no">505</span><span id="line-505">    private FileHeader readFileHeader(final InputStream is) throws ImagingException, IOException {</span>
<span class="source-line-no">506</span><span id="line-506">        final int reserved = read2Bytes("Reserved", is, "Not a Valid ICO File", getByteOrder());</span>
<span class="source-line-no">507</span><span id="line-507">        final int iconType = read2Bytes("IconType", is, "Not a Valid ICO File", getByteOrder());</span>
<span class="source-line-no">508</span><span id="line-508">        final int iconCount = read2Bytes("IconCount", is, "Not a Valid ICO File", getByteOrder());</span>
<span class="source-line-no">509</span><span id="line-509"></span>
<span class="source-line-no">510</span><span id="line-510">        if (reserved != 0) {</span>
<span class="source-line-no">511</span><span id="line-511">            throw new ImagingException("Not a Valid ICO File: reserved is " + reserved);</span>
<span class="source-line-no">512</span><span id="line-512">        }</span>
<span class="source-line-no">513</span><span id="line-513">        if (iconType != 1 &amp;&amp; iconType != 2) {</span>
<span class="source-line-no">514</span><span id="line-514">            throw new ImagingException("Not a Valid ICO File: icon type is " + iconType);</span>
<span class="source-line-no">515</span><span id="line-515">        }</span>
<span class="source-line-no">516</span><span id="line-516"></span>
<span class="source-line-no">517</span><span id="line-517">        return new FileHeader(reserved, iconType, iconCount);</span>
<span class="source-line-no">518</span><span id="line-518"></span>
<span class="source-line-no">519</span><span id="line-519">    }</span>
<span class="source-line-no">520</span><span id="line-520"></span>
<span class="source-line-no">521</span><span id="line-521">    private IconData readIconData(final byte[] iconData, final IconInfo fIconInfo) throws ImagingException, IOException {</span>
<span class="source-line-no">522</span><span id="line-522">        final ImageFormat imageFormat = Imaging.guessFormat(iconData);</span>
<span class="source-line-no">523</span><span id="line-523">        if (imageFormat.equals(ImageFormats.PNG)) {</span>
<span class="source-line-no">524</span><span id="line-524">            final BufferedImage bufferedImage = Imaging.getBufferedImage(iconData);</span>
<span class="source-line-no">525</span><span id="line-525">            return new PngIconData(fIconInfo, bufferedImage);</span>
<span class="source-line-no">526</span><span id="line-526">        }</span>
<span class="source-line-no">527</span><span id="line-527">        return readBitmapIconData(iconData, fIconInfo);</span>
<span class="source-line-no">528</span><span id="line-528">    }</span>
<span class="source-line-no">529</span><span id="line-529"></span>
<span class="source-line-no">530</span><span id="line-530">    private IconInfo readIconInfo(final InputStream is) throws IOException {</span>
<span class="source-line-no">531</span><span id="line-531">        // Width (1 byte), Width of Icon (1 to 255)</span>
<span class="source-line-no">532</span><span id="line-532">        final byte width = readByte("Width", is, "Not a Valid ICO File");</span>
<span class="source-line-no">533</span><span id="line-533">        // Height (1 byte), Height of Icon (1 to 255)</span>
<span class="source-line-no">534</span><span id="line-534">        final byte height = readByte("Height", is, "Not a Valid ICO File");</span>
<span class="source-line-no">535</span><span id="line-535">        // ColorCount (1 byte), Number of colors, either</span>
<span class="source-line-no">536</span><span id="line-536">        // 0 for 24 bit or higher,</span>
<span class="source-line-no">537</span><span id="line-537">        // 2 for monochrome or 16 for 16 color images.</span>
<span class="source-line-no">538</span><span id="line-538">        final byte colorCount = readByte("ColorCount", is, "Not a Valid ICO File");</span>
<span class="source-line-no">539</span><span id="line-539">        // Reserved (1 byte), Not used (always 0)</span>
<span class="source-line-no">540</span><span id="line-540">        final byte reserved = readByte("Reserved", is, "Not a Valid ICO File");</span>
<span class="source-line-no">541</span><span id="line-541">        // Planes (2 bytes), always 1</span>
<span class="source-line-no">542</span><span id="line-542">        final int planes = read2Bytes("Planes", is, "Not a Valid ICO File", getByteOrder());</span>
<span class="source-line-no">543</span><span id="line-543">        // BitCount (2 bytes), number of bits per pixel (1 for monochrome,</span>
<span class="source-line-no">544</span><span id="line-544">        // 4 for 16 colors, 8 for 256 colors, 24 for true colors,</span>
<span class="source-line-no">545</span><span id="line-545">        // 32 for true colors + alpha channel)</span>
<span class="source-line-no">546</span><span id="line-546">        final int bitCount = read2Bytes("BitCount", is, "Not a Valid ICO File", getByteOrder());</span>
<span class="source-line-no">547</span><span id="line-547">        // ImageSize (4 bytes), Length of resource in bytes</span>
<span class="source-line-no">548</span><span id="line-548">        final int imageSize = read4Bytes("ImageSize", is, "Not a Valid ICO File", getByteOrder());</span>
<span class="source-line-no">549</span><span id="line-549">        // ImageOffset (4 bytes), start of the image in the file</span>
<span class="source-line-no">550</span><span id="line-550">        final int imageOffset = read4Bytes("ImageOffset", is, "Not a Valid ICO File", getByteOrder());</span>
<span class="source-line-no">551</span><span id="line-551"></span>
<span class="source-line-no">552</span><span id="line-552">        return new IconInfo(width, height, colorCount, reserved, planes, bitCount, imageSize, imageOffset);</span>
<span class="source-line-no">553</span><span id="line-553">    }</span>
<span class="source-line-no">554</span><span id="line-554"></span>
<span class="source-line-no">555</span><span id="line-555">    private ImageContents readImage(final ByteSource byteSource) throws ImagingException, IOException {</span>
<span class="source-line-no">556</span><span id="line-556">        try (InputStream is = byteSource.getInputStream()) {</span>
<span class="source-line-no">557</span><span id="line-557">            final FileHeader fileHeader = readFileHeader(is);</span>
<span class="source-line-no">558</span><span id="line-558"></span>
<span class="source-line-no">559</span><span id="line-559">            final IconInfo[] fIconInfos = Allocator.array(fileHeader.iconCount, IconInfo[]::new, IconInfo.SHALLOW_SIZE);</span>
<span class="source-line-no">560</span><span id="line-560">            for (int i = 0; i &lt; fileHeader.iconCount; i++) {</span>
<span class="source-line-no">561</span><span id="line-561">                fIconInfos[i] = readIconInfo(is);</span>
<span class="source-line-no">562</span><span id="line-562">            }</span>
<span class="source-line-no">563</span><span id="line-563"></span>
<span class="source-line-no">564</span><span id="line-564">            final IconData[] fIconDatas = Allocator.array(fileHeader.iconCount, IconData[]::new, IconData.SHALLOW_SIZE);</span>
<span class="source-line-no">565</span><span id="line-565">            for (int i = 0; i &lt; fileHeader.iconCount; i++) {</span>
<span class="source-line-no">566</span><span id="line-566">                final byte[] iconData = byteSource.getByteArray(fIconInfos[i].imageOffset, fIconInfos[i].imageSize);</span>
<span class="source-line-no">567</span><span id="line-567">                fIconDatas[i] = readIconData(iconData, fIconInfos[i]);</span>
<span class="source-line-no">568</span><span id="line-568">            }</span>
<span class="source-line-no">569</span><span id="line-569"></span>
<span class="source-line-no">570</span><span id="line-570">            return new ImageContents(fileHeader, fIconDatas);</span>
<span class="source-line-no">571</span><span id="line-571">        }</span>
<span class="source-line-no">572</span><span id="line-572">    }</span>
<span class="source-line-no">573</span><span id="line-573"></span>
<span class="source-line-no">574</span><span id="line-574">    // public boolean extractImages(ByteSource byteSource, File dst_dir,</span>
<span class="source-line-no">575</span><span id="line-575">    // String dst_root, ImageParser encoder) throws ImageReadException,</span>
<span class="source-line-no">576</span><span id="line-576">    // IOException, ImageWriteException</span>
<span class="source-line-no">577</span><span id="line-577">    // {</span>
<span class="source-line-no">578</span><span id="line-578">    // ImageContents contents = readImage(byteSource);</span>
<span class="source-line-no">579</span><span id="line-579">    //</span>
<span class="source-line-no">580</span><span id="line-580">    // FileHeader fileHeader = contents.fileHeader;</span>
<span class="source-line-no">581</span><span id="line-581">    // for (int i = 0; i &lt; fileHeader.iconCount; i++)</span>
<span class="source-line-no">582</span><span id="line-582">    // {</span>
<span class="source-line-no">583</span><span id="line-583">    // IconData iconData = contents.iconDatas[i];</span>
<span class="source-line-no">584</span><span id="line-584">    //</span>
<span class="source-line-no">585</span><span id="line-585">    // BufferedImage image = readBufferedImage(iconData);</span>
<span class="source-line-no">586</span><span id="line-586">    //</span>
<span class="source-line-no">587</span><span id="line-587">    // int size = Math.max(iconData.iconInfo.Width,</span>
<span class="source-line-no">588</span><span id="line-588">    // iconData.iconInfo.Height);</span>
<span class="source-line-no">589</span><span id="line-589">    // File file = new File(dst_dir, dst_root + "_" + size + "_"</span>
<span class="source-line-no">590</span><span id="line-590">    // + iconData.iconInfo.BitCount</span>
<span class="source-line-no">591</span><span id="line-591">    // + encoder.getDefaultExtension());</span>
<span class="source-line-no">592</span><span id="line-592">    // encoder.writeImage(image, new FileOutputStream(file), null);</span>
<span class="source-line-no">593</span><span id="line-593">    // }</span>
<span class="source-line-no">594</span><span id="line-594">    //</span>
<span class="source-line-no">595</span><span id="line-595">    // return true;</span>
<span class="source-line-no">596</span><span id="line-596">    // }</span>
<span class="source-line-no">597</span><span id="line-597"></span>
<span class="source-line-no">598</span><span id="line-598">    @Override</span>
<span class="source-line-no">599</span><span id="line-599">    public void writeImage(final BufferedImage src, final OutputStream os, IcoImagingParameters params) throws ImagingException, IOException {</span>
<span class="source-line-no">600</span><span id="line-600">        if (params == null) {</span>
<span class="source-line-no">601</span><span id="line-601">            params = new IcoImagingParameters();</span>
<span class="source-line-no">602</span><span id="line-602">        }</span>
<span class="source-line-no">603</span><span id="line-603">        final PixelDensity pixelDensity = params.getPixelDensity();</span>
<span class="source-line-no">604</span><span id="line-604"></span>
<span class="source-line-no">605</span><span id="line-605">        final PaletteFactory paletteFactory = new PaletteFactory();</span>
<span class="source-line-no">606</span><span id="line-606">        final SimplePalette palette = paletteFactory.makeExactRgbPaletteSimple(src, 256);</span>
<span class="source-line-no">607</span><span id="line-607">        final int bitCount;</span>
<span class="source-line-no">608</span><span id="line-608">        // If we can't obtain an exact rgb palette, we set the bit count to either 24 or 32</span>
<span class="source-line-no">609</span><span id="line-609">        // so there is a relation between having a palette and the bit count.</span>
<span class="source-line-no">610</span><span id="line-610">        if (palette == null) {</span>
<span class="source-line-no">611</span><span id="line-611">            final boolean hasTransparency = paletteFactory.hasTransparency(src);</span>
<span class="source-line-no">612</span><span id="line-612">            if (hasTransparency) {</span>
<span class="source-line-no">613</span><span id="line-613">                bitCount = 32;</span>
<span class="source-line-no">614</span><span id="line-614">            } else {</span>
<span class="source-line-no">615</span><span id="line-615">                bitCount = 24;</span>
<span class="source-line-no">616</span><span id="line-616">            }</span>
<span class="source-line-no">617</span><span id="line-617">        } else if (palette.length() &lt;= 2) {</span>
<span class="source-line-no">618</span><span id="line-618">            bitCount = 1;</span>
<span class="source-line-no">619</span><span id="line-619">        } else if (palette.length() &lt;= 16) {</span>
<span class="source-line-no">620</span><span id="line-620">            bitCount = 4;</span>
<span class="source-line-no">621</span><span id="line-621">        } else {</span>
<span class="source-line-no">622</span><span id="line-622">            bitCount = 8;</span>
<span class="source-line-no">623</span><span id="line-623">        }</span>
<span class="source-line-no">624</span><span id="line-624"></span>
<span class="source-line-no">625</span><span id="line-625">        try (BinaryOutputStream bos = BinaryOutputStream.littleEndian(os)) {</span>
<span class="source-line-no">626</span><span id="line-626"></span>
<span class="source-line-no">627</span><span id="line-627">            int scanlineSize = (bitCount * src.getWidth() + 7) / 8;</span>
<span class="source-line-no">628</span><span id="line-628">            if (scanlineSize % 4 != 0) {</span>
<span class="source-line-no">629</span><span id="line-629">                scanlineSize += 4 - scanlineSize % 4; // pad scanline to 4 byte</span>
<span class="source-line-no">630</span><span id="line-630">                                                      // size.</span>
<span class="source-line-no">631</span><span id="line-631">            }</span>
<span class="source-line-no">632</span><span id="line-632">            int tScanlineSize = (src.getWidth() + 7) / 8;</span>
<span class="source-line-no">633</span><span id="line-633">            if (tScanlineSize % 4 != 0) {</span>
<span class="source-line-no">634</span><span id="line-634">                tScanlineSize += 4 - tScanlineSize % 4; // pad scanline to 4</span>
<span class="source-line-no">635</span><span id="line-635">                                                        // byte size.</span>
<span class="source-line-no">636</span><span id="line-636">            }</span>
<span class="source-line-no">637</span><span id="line-637">            final int imageSize = 40 + 4 * (bitCount &lt;= 8 ? 1 &lt;&lt; bitCount : 0) + src.getHeight() * scanlineSize + src.getHeight() * tScanlineSize;</span>
<span class="source-line-no">638</span><span id="line-638"></span>
<span class="source-line-no">639</span><span id="line-639">            // ICONDIR</span>
<span class="source-line-no">640</span><span id="line-640">            bos.write2Bytes(0); // reserved</span>
<span class="source-line-no">641</span><span id="line-641">            bos.write2Bytes(1); // 1=ICO, 2=CUR</span>
<span class="source-line-no">642</span><span id="line-642">            bos.write2Bytes(1); // count</span>
<span class="source-line-no">643</span><span id="line-643"></span>
<span class="source-line-no">644</span><span id="line-644">            // ICONDIRENTRY</span>
<span class="source-line-no">645</span><span id="line-645">            int iconDirEntryWidth = src.getWidth();</span>
<span class="source-line-no">646</span><span id="line-646">            int iconDirEntryHeight = src.getHeight();</span>
<span class="source-line-no">647</span><span id="line-647">            if (iconDirEntryWidth &gt; 255 || iconDirEntryHeight &gt; 255) {</span>
<span class="source-line-no">648</span><span id="line-648">                iconDirEntryWidth = 0;</span>
<span class="source-line-no">649</span><span id="line-649">                iconDirEntryHeight = 0;</span>
<span class="source-line-no">650</span><span id="line-650">            }</span>
<span class="source-line-no">651</span><span id="line-651">            bos.write(iconDirEntryWidth);</span>
<span class="source-line-no">652</span><span id="line-652">            bos.write(iconDirEntryHeight);</span>
<span class="source-line-no">653</span><span id="line-653">            bos.write(bitCount &gt;= 8 ? 0 : 1 &lt;&lt; bitCount);</span>
<span class="source-line-no">654</span><span id="line-654">            bos.write(0); // reserved</span>
<span class="source-line-no">655</span><span id="line-655">            bos.write2Bytes(1); // color planes</span>
<span class="source-line-no">656</span><span id="line-656">            bos.write2Bytes(bitCount);</span>
<span class="source-line-no">657</span><span id="line-657">            bos.write4Bytes(imageSize);</span>
<span class="source-line-no">658</span><span id="line-658">            bos.write4Bytes(22); // image offset</span>
<span class="source-line-no">659</span><span id="line-659"></span>
<span class="source-line-no">660</span><span id="line-660">            // BITMAPINFOHEADER</span>
<span class="source-line-no">661</span><span id="line-661">            bos.write4Bytes(40); // size</span>
<span class="source-line-no">662</span><span id="line-662">            bos.write4Bytes(src.getWidth());</span>
<span class="source-line-no">663</span><span id="line-663">            bos.write4Bytes(2 * src.getHeight());</span>
<span class="source-line-no">664</span><span id="line-664">            bos.write2Bytes(1); // planes</span>
<span class="source-line-no">665</span><span id="line-665">            bos.write2Bytes(bitCount);</span>
<span class="source-line-no">666</span><span id="line-666">            bos.write4Bytes(0); // compression</span>
<span class="source-line-no">667</span><span id="line-667">            bos.write4Bytes(0); // image size</span>
<span class="source-line-no">668</span><span id="line-668">            bos.write4Bytes(pixelDensity == null ? 0 : (int) Math.round(pixelDensity.horizontalDensityMetres())); // x</span>
<span class="source-line-no">669</span><span id="line-669">                                                                                                                  // pixels</span>
<span class="source-line-no">670</span><span id="line-670">                                                                                                                  // per</span>
<span class="source-line-no">671</span><span id="line-671">                                                                                                                  // meter</span>
<span class="source-line-no">672</span><span id="line-672">            bos.write4Bytes(pixelDensity == null ? 0 : (int) Math.round(pixelDensity.horizontalDensityMetres())); // y</span>
<span class="source-line-no">673</span><span id="line-673">                                                                                                                  // pixels</span>
<span class="source-line-no">674</span><span id="line-674">                                                                                                                  // per</span>
<span class="source-line-no">675</span><span id="line-675">                                                                                                                  // meter</span>
<span class="source-line-no">676</span><span id="line-676">            bos.write4Bytes(0); // colors used, 0 = (1 &lt;&lt; bitCount) (ignored)</span>
<span class="source-line-no">677</span><span id="line-677">            bos.write4Bytes(0); // colors important</span>
<span class="source-line-no">678</span><span id="line-678"></span>
<span class="source-line-no">679</span><span id="line-679">            if (palette != null) {</span>
<span class="source-line-no">680</span><span id="line-680">                for (int i = 0; i &lt; 1 &lt;&lt; bitCount; i++) {</span>
<span class="source-line-no">681</span><span id="line-681">                    if (i &lt; palette.length()) {</span>
<span class="source-line-no">682</span><span id="line-682">                        final int argb = palette.getEntry(i);</span>
<span class="source-line-no">683</span><span id="line-683">                        bos.write3Bytes(argb);</span>
<span class="source-line-no">684</span><span id="line-684">                        bos.write(0);</span>
<span class="source-line-no">685</span><span id="line-685">                    } else {</span>
<span class="source-line-no">686</span><span id="line-686">                        bos.write4Bytes(0);</span>
<span class="source-line-no">687</span><span id="line-687">                    }</span>
<span class="source-line-no">688</span><span id="line-688">                }</span>
<span class="source-line-no">689</span><span id="line-689">            }</span>
<span class="source-line-no">690</span><span id="line-690"></span>
<span class="source-line-no">691</span><span id="line-691">            int bitCache = 0;</span>
<span class="source-line-no">692</span><span id="line-692">            int bitsInCache = 0;</span>
<span class="source-line-no">693</span><span id="line-693">            final int rowPadding = scanlineSize - (bitCount * src.getWidth() + 7) / 8;</span>
<span class="source-line-no">694</span><span id="line-694">            for (int y = src.getHeight() - 1; y &gt;= 0; y--) {</span>
<span class="source-line-no">695</span><span id="line-695">                for (int x = 0; x &lt; src.getWidth(); x++) {</span>
<span class="source-line-no">696</span><span id="line-696">                    final int argb = src.getRGB(x, y);</span>
<span class="source-line-no">697</span><span id="line-697">                    // Remember there is a relation between having a rgb palette and the bit count, see above comment</span>
<span class="source-line-no">698</span><span id="line-698">                    if (palette == null) {</span>
<span class="source-line-no">699</span><span id="line-699">                        if (bitCount == 24) {</span>
<span class="source-line-no">700</span><span id="line-700">                            bos.write3Bytes(argb);</span>
<span class="source-line-no">701</span><span id="line-701">                        } else if (bitCount == 32) {</span>
<span class="source-line-no">702</span><span id="line-702">                            bos.write4Bytes(argb);</span>
<span class="source-line-no">703</span><span id="line-703">                        }</span>
<span class="source-line-no">704</span><span id="line-704">                    } else if (bitCount &lt; 8) {</span>
<span class="source-line-no">705</span><span id="line-705">                        final int rgb = 0xffffff &amp; argb;</span>
<span class="source-line-no">706</span><span id="line-706">                        final int index = palette.getPaletteIndex(rgb);</span>
<span class="source-line-no">707</span><span id="line-707">                        bitCache &lt;&lt;= bitCount;</span>
<span class="source-line-no">708</span><span id="line-708">                        bitCache |= index;</span>
<span class="source-line-no">709</span><span id="line-709">                        bitsInCache += bitCount;</span>
<span class="source-line-no">710</span><span id="line-710">                        if (bitsInCache &gt;= 8) {</span>
<span class="source-line-no">711</span><span id="line-711">                            bos.write(0xff &amp; bitCache);</span>
<span class="source-line-no">712</span><span id="line-712">                            bitCache = 0;</span>
<span class="source-line-no">713</span><span id="line-713">                            bitsInCache = 0;</span>
<span class="source-line-no">714</span><span id="line-714">                        }</span>
<span class="source-line-no">715</span><span id="line-715">                    } else if (bitCount == 8) {</span>
<span class="source-line-no">716</span><span id="line-716">                        final int rgb = 0xffffff &amp; argb;</span>
<span class="source-line-no">717</span><span id="line-717">                        final int index = palette.getPaletteIndex(rgb);</span>
<span class="source-line-no">718</span><span id="line-718">                        bos.write(0xff &amp; index);</span>
<span class="source-line-no">719</span><span id="line-719">                    }</span>
<span class="source-line-no">720</span><span id="line-720">                }</span>
<span class="source-line-no">721</span><span id="line-721"></span>
<span class="source-line-no">722</span><span id="line-722">                if (bitsInCache &gt; 0) {</span>
<span class="source-line-no">723</span><span id="line-723">                    bitCache &lt;&lt;= 8 - bitsInCache;</span>
<span class="source-line-no">724</span><span id="line-724">                    bos.write(0xff &amp; bitCache);</span>
<span class="source-line-no">725</span><span id="line-725">                    bitCache = 0;</span>
<span class="source-line-no">726</span><span id="line-726">                    bitsInCache = 0;</span>
<span class="source-line-no">727</span><span id="line-727">                }</span>
<span class="source-line-no">728</span><span id="line-728"></span>
<span class="source-line-no">729</span><span id="line-729">                for (int x = 0; x &lt; rowPadding; x++) {</span>
<span class="source-line-no">730</span><span id="line-730">                    bos.write(0);</span>
<span class="source-line-no">731</span><span id="line-731">                }</span>
<span class="source-line-no">732</span><span id="line-732">            }</span>
<span class="source-line-no">733</span><span id="line-733"></span>
<span class="source-line-no">734</span><span id="line-734">            final int tRowPadding = tScanlineSize - (src.getWidth() + 7) / 8;</span>
<span class="source-line-no">735</span><span id="line-735">            for (int y = src.getHeight() - 1; y &gt;= 0; y--) {</span>
<span class="source-line-no">736</span><span id="line-736">                for (int x = 0; x &lt; src.getWidth(); x++) {</span>
<span class="source-line-no">737</span><span id="line-737">                    final int argb = src.getRGB(x, y);</span>
<span class="source-line-no">738</span><span id="line-738">                    final int alpha = 0xff &amp; argb &gt;&gt; 24;</span>
<span class="source-line-no">739</span><span id="line-739">                    bitCache &lt;&lt;= 1;</span>
<span class="source-line-no">740</span><span id="line-740">                    if (alpha == 0) {</span>
<span class="source-line-no">741</span><span id="line-741">                        bitCache |= 1;</span>
<span class="source-line-no">742</span><span id="line-742">                    }</span>
<span class="source-line-no">743</span><span id="line-743">                    bitsInCache++;</span>
<span class="source-line-no">744</span><span id="line-744">                    if (bitsInCache &gt;= 8) {</span>
<span class="source-line-no">745</span><span id="line-745">                        bos.write(0xff &amp; bitCache);</span>
<span class="source-line-no">746</span><span id="line-746">                        bitCache = 0;</span>
<span class="source-line-no">747</span><span id="line-747">                        bitsInCache = 0;</span>
<span class="source-line-no">748</span><span id="line-748">                    }</span>
<span class="source-line-no">749</span><span id="line-749">                }</span>
<span class="source-line-no">750</span><span id="line-750"></span>
<span class="source-line-no">751</span><span id="line-751">                if (bitsInCache &gt; 0) {</span>
<span class="source-line-no">752</span><span id="line-752">                    bitCache &lt;&lt;= 8 - bitsInCache;</span>
<span class="source-line-no">753</span><span id="line-753">                    bos.write(0xff &amp; bitCache);</span>
<span class="source-line-no">754</span><span id="line-754">                    bitCache = 0;</span>
<span class="source-line-no">755</span><span id="line-755">                    bitsInCache = 0;</span>
<span class="source-line-no">756</span><span id="line-756">                }</span>
<span class="source-line-no">757</span><span id="line-757"></span>
<span class="source-line-no">758</span><span id="line-758">                for (int x = 0; x &lt; tRowPadding; x++) {</span>
<span class="source-line-no">759</span><span id="line-759">                    bos.write(0);</span>
<span class="source-line-no">760</span><span id="line-760">                }</span>
<span class="source-line-no">761</span><span id="line-761">            }</span>
<span class="source-line-no">762</span><span id="line-762">        }</span>
<span class="source-line-no">763</span><span id="line-763">    }</span>
<span class="source-line-no">764</span><span id="line-764">}</span>




























































</pre>
</div>
</main>
</body>
</html>
